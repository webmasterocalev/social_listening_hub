<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Listening Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Biblioteca do Calendário -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script> <!-- Tradução do calendário -->
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chart-container {
            position: relative;
            height: 280px;
            width: 100%;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        /* Estilo para o modal de feedback */
        .feedback-modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .flatpickr-input {
            cursor: pointer;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Cabeçalho -->
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-500 p-2 rounded-lg text-white">
                        <svg class="lucide lucide-ear" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8.5a6.5 6.5 0 1 1 13 0c0 6-6 6-6 6a6.5 6.5 0 0 0-7 0"/><path d="M15 8.5a2.5 2.5 0 0 0-5 0v1a2.5 2.5 0 0 0 5 0V8.5Z"/></svg>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-800">Social Listening Hub</h1>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main class="flex-grow container mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Coluna do Formulário -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg h-fit">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    <i data-lucide="plus-circle" class="text-indigo-500"></i>
                    Adicionar Nova Menção
                </h2>
                <form id="mention-form" class="space-y-4">
                    
                    <div>
                        <label for="date" class="block text-sm font-medium text-slate-600 mb-1">Data</label>
                        <input type="date" id="date" name="date" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>

                    <div>
                        <label for="channel" class="block text-sm font-medium text-slate-600 mb-1">Canal / Origem</label>
                        <select id="channel" name="channel" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option>Instagram (comentário)</option>
                            <option>Instagram (DM)</option>
                            <option>Facebook (comentário)</option>
                            <option>Facebook (DM)</option>
                            <option>TikTok (comentário)</option>
                            <option>TikTok (DM)</option>
                            <option>YouTube (comentário)</option>
                            <option>Site / Blog</option>
                            <option>LinkedIn</option>
                            <option>Outro</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="author" class="block text-sm font-medium text-slate-600 mb-1">Autor</label>
                        <input type="text" id="author" name="author" placeholder="@usuario (opcional)" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>

                    <div>
                        <label for="link" class="block text-sm font-medium text-slate-600 mb-1">Link</label>
                        <input type="url" id="link" name="link" placeholder="https://..." required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                    
                    <div>
                        <label for="sentiment" class="block text-sm font-medium text-slate-600 mb-1">Sentimento</label>
                        <select id="sentiment" name="sentiment" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="Positivo">Positivo</option>
                            <option value="Negativo">Negativo</option>
                            <option value="Neutro" selected>Neutro</option>
                        </select>
                    </div>

                    <div>
                        <label for="topic" class="block text-sm font-medium text-slate-600 mb-1">Tópico Principal</label>
                        <select id="topic" name="topic" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                             <option>Atendimento</option>
                             <option>Produto</option>
                             <option>Preço</option>
                             <option>Entrega</option>
                             <option>Marketing/Campanha</option>
                             <option>Sugestão</option>
                             <option>Outro</option>
                        </select>
                    </div>

                    <div>
                        <label for="content" class="block text-sm font-medium text-slate-600 mb-1">Conteúdo / Resumo</label>
                        <textarea id="content" name="content" rows="4" placeholder="O que foi dito?" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                    </div>
                    
                    <button type="submit" id="submit-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center gap-2">
                        <span id="button-text">
                            <i data-lucide="send" class="inline-block mr-2"></i>Salvar Menção
                        </span>
                        <span id="button-loader" class="hidden">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </form>
            </div>

            <!-- Coluna do Dashboard -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Filtros -->
                 <div class="bg-white p-4 rounded-2xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i data-lucide="filter" class="text-slate-500"></i>Filtros</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="filter-channel" class="block text-sm font-medium text-slate-600 mb-1">Canal</label>
                            <select id="filter-channel" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                <option value="all">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-sentiment" class="block text-sm font-medium text-slate-600 mb-1">Sentimento</label>
                            <select id="filter-sentiment" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                <option value="all">Todos</option>
                                <option value="Positivo">Positivo</option>
                                <option value="Negativo">Negativo</option>
                                <option value="Neutro">Neutro</option>
                            </select>
                        </div>
                         <div class="sm:col-span-2">
                            <label for="filter-date-range" class="block text-sm font-medium text-slate-600 mb-1">Período</label>
                             <div class="relative">
                                <input type="text" id="filter-date-range" placeholder="Selecione um período..." class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                <button id="clear-date-filter" class="absolute top-1/2 right-3 -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Métricas Principais -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h4 class="text-sm font-medium text-slate-500">Total de Menções</h4>
                        <p id="kpi-total" class="text-3xl font-bold text-indigo-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h4 class="text-sm font-medium text-slate-500">Positivas</h4>
                        <p id="kpi-positive" class="text-3xl font-bold text-emerald-500">0%</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h4 class="text-sm font-medium text-slate-500">Negativas</h4>
                        <p id="kpi-negative" class="text-3xl font-bold text-red-500">0%</p>
                    </div>
                     <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h4 class="text-sm font-medium text-slate-500">Neutras</h4>
                        <p id="kpi-neutral" class="text-3xl font-bold text-slate-500">0%</p>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Sentimento Geral</h3>
                        <div class="chart-container"><canvas id="sentiment-chart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Menções por Canal</h3>
                        <div class="chart-container"><canvas id="channel-chart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg md:col-span-2">
                        <h3 class="text-lg font-semibold mb-4">Tópicos Mais Comentados</h3>
                        <div class="chart-container"><canvas id="topic-chart"></canvas></div>
                    </div>
                </div>

                <!-- Feed de Menções Recentes -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><i data-lucide="message-square-text" class="text-slate-500"></i>Menções Recentes</h3>
                    <div id="mentions-feed" class="max-h-96 overflow-y-auto space-y-4 pr-2">
                        <p class="text-slate-500 text-center py-4">Nenhuma menção encontrada para os filtros selecionados.</p>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal de Feedback -->
    <div id="feedback-modal" class="feedback-modal fixed top-5 right-5 bg-white p-4 rounded-lg shadow-2xl flex items-center gap-4 border-l-4 opacity-0 transform translate-y-2 pointer-events-none">
        <div id="modal-icon"></div>
        <p id="modal-message" class="font-medium text-slate-700"></p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =====================================================================
            // CONFIGURAÇÃO
            // =====================================================================
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwXlXranbWPM8ZPwVnXztEcnyhz2g_HRQkK6dfmmoNWLv-RkNWL46omvRegFKuLFXra/exec'; 
            
            // Inicialização dos ícones Lucide
            lucide.createIcons();

            // Referências aos elementos do DOM
            const form = document.getElementById('mention-form');
            const submitButton = document.getElementById('submit-button');
            const buttonText = document.getElementById('button-text');
            const buttonLoader = document.getElementById('button-loader');
            const filterChannel = document.getElementById('filter-channel');
            const filterSentiment = document.getElementById('filter-sentiment');
            const filterDateRange = document.getElementById('filter-date-range');
            const clearDateFilterBtn = document.getElementById('clear-date-filter');
            const mentionsFeedContainer = document.getElementById('mentions-feed');
            
            // Variáveis de estado e gráficos
            let mentions = [];
            let sentimentChart, channelChart, topicChart;

            // Cores padrão para os gráficos
            const sentimentColors = {
                'Positivo': 'rgba(16, 185, 129, 0.7)', // emerald-500
                'Negativo': 'rgba(239, 68, 68, 0.7)',   // red-500
                'Neutro': 'rgba(100, 116, 139, 0.7)'  // slate-500
            };
            const chartColors = [
                'rgba(99, 102, 241, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(14, 165, 233, 0.7)',
                'rgba(34, 197, 94, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(168, 85, 247, 0.7)',
            ];
            
            const datePicker = flatpickr(filterDateRange, {
                mode: "range",
                dateFormat: "d/m/Y",
                locale: "pt",
                onChange: function(selectedDates, dateStr, instance) {
                    updateDashboard();
                    clearDateFilterBtn.classList.toggle('hidden', selectedDates.length === 0);
                }
            });

            clearDateFilterBtn.addEventListener('click', () => datePicker.clear());

            const showFeedback = (message, type = 'success') => {
                const modal = document.getElementById('feedback-modal');
                const iconContainer = document.getElementById('modal-icon');
                const messageEl = document.getElementById('modal-message');

                messageEl.textContent = message;
                modal.classList.toggle('border-emerald-500', type === 'success');
                modal.classList.toggle('border-red-500', type !== 'success');
                iconContainer.innerHTML = type === 'success' 
                    ? `<i data-lucide="check-circle" class="text-emerald-500"></i>`
                    : `<i data-lucide="x-circle" class="text-red-500"></i>`;
                lucide.createIcons();
                
                modal.classList.remove('opacity-0', 'translate-y-2');
                setTimeout(() => modal.classList.add('opacity-0', 'translate-y-2'), 3000);
            };
            
            const loadMentions = async () => {
                if (SCRIPT_URL === 'COLE_A_URL_DO_SEU_SCRIPT_AQUI') {
                    showFeedback('Configure a URL do seu Apps Script!', 'error');
                    return;
                }
                try {
                    const response = await fetch(SCRIPT_URL);
                    if (!response.ok) throw new Error('Erro ao buscar dados da planilha.');
                    const data = await response.json();
                    mentions = data.sort((a, b) => new Date(b.date) - new Date(a.date));
                    populateChannelFilter();
                    updateDashboard();
                } catch (error) {
                    console.error('Falha ao carregar menções:', error);
                    showFeedback('Não foi possível carregar os dados.', 'error');
                }
            };

            const populateChannelFilter = () => {
                const channels = [...new Set(mentions.map(m => m.channel))];
                filterChannel.innerHTML = '<option value="all">Todos</option>';
                channels.sort().forEach(channel => {
                    filterChannel.innerHTML += `<option value="${channel}">${channel}</option>`;
                });
            };
            
            const renderMentionsFeed = (data) => {
                mentionsFeedContainer.innerHTML = '';
                if (data.length === 0) {
                    mentionsFeedContainer.innerHTML = `<p class="text-slate-500 text-center py-4">Nenhuma menção para os filtros selecionados.</p>`;
                    return;
                }

                const sentimentInfo = {
                    'Positivo': { icon: 'thumbs-up', color: 'text-emerald-500', bg: 'bg-emerald-50' },
                    'Negativo': { icon: 'thumbs-down', color: 'text-red-500', bg: 'bg-red-50' },
                    'Neutro': { icon: 'message-circle', color: 'text-slate-500', bg: 'bg-slate-50' }
                };

                data.forEach(mention => {
                    const s = sentimentInfo[mention.sentiment] || sentimentInfo['Neutro'];
                    const formattedDate = new Date(mention.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                    const authorHTML = mention.author ? `
                        <span class="text-slate-300">|</span>
                        <span>por <strong>${mention.author}</strong></span>` : '';

                    const cardHTML = `
                        <div class="p-3 rounded-lg border ${s.bg} flex gap-3 items-start">
                            <div class="${s.color} mt-1 flex-shrink-0"><i data-lucide="${s.icon}" class="w-5 h-5"></i></div>
                            <div>
                                <p class="text-slate-800 text-sm break-words">"${mention.content}"</p>
                                <div class="text-xs text-slate-500 mt-2 flex items-center gap-2 flex-wrap">
                                    <span><a href="${mention.link}" target="_blank" class="hover:underline"><strong>${mention.channel}</strong></a></span>
                                    <span class="text-slate-300">|</span>
                                    <span>${formattedDate}</span>
                                    ${authorHTML}
                                </div>
                            </div>
                        </div>`;
                    mentionsFeedContainer.insertAdjacentHTML('beforeend', cardHTML);
                });
                lucide.createIcons();
            };

            const updateDashboard = () => {
                const channelFilterValue = filterChannel.value;
                const sentimentFilterValue = filterSentiment.value;
                const selectedDates = datePicker.selectedDates;

                let filteredMentions = mentions;

                // ===== INÍCIO DA CORREÇÃO DEFINITIVA DO FILTRO DE DATA =====
                if (selectedDates.length > 0) {
                    const getDayTimestamp = (dateInput) => {
                        if (typeof dateInput === 'string' && dateInput.includes('-')) {
                            const parts = dateInput.split('-').map(Number);
                            return Date.UTC(parts[0], parts[1] - 1, parts[2]);
                        }
                        const d = new Date(dateInput);
                        return Date.UTC(d.getFullYear(), d.getMonth(), d.getDate());
                    };
                    
                    // Lógica para data única ou range
                    // Se o usuário selecionou apenas uma data, o flatpickr em modo 'range'
                    // armazena essa data como início e fim.
                    const startTimestamp = getDayTimestamp(selectedDates[0]);
                    const endTimestamp = selectedDates.length > 1 ? getDayTimestamp(selectedDates[1]) : startTimestamp;
                    
                    filteredMentions = filteredMentions.filter(m => {
                        const mentionTimestamp = getDayTimestamp(m.date);
                        return mentionTimestamp >= startTimestamp && mentionTimestamp <= endTimestamp;
                    });
                }
                // ===== FIM DA CORREÇÃO DEFINITIVA DO FILTRO DE DATA =====
                
                if (channelFilterValue !== 'all') filteredMentions = filteredMentions.filter(m => m.channel === channelFilterValue);
                if (sentimentFilterValue !== 'all') filteredMentions = filteredMentions.filter(m => m.sentiment === sentimentFilterValue);
                
                const total = filteredMentions.length;
                document.getElementById('kpi-total').textContent = total;

                if (total > 0) {
                    const positives = filteredMentions.filter(m => m.sentiment === 'Positivo').length;
                    document.getElementById('kpi-positive').textContent = `${((positives / total) * 100).toFixed(0)}%`;
                    const negatives = filteredMentions.filter(m => m.sentiment === 'Negativo').length;
                    document.getElementById('kpi-negative').textContent = `${((negatives / total) * 100).toFixed(0)}%`;
                    const neutrals = total - positives - negatives;
                    document.getElementById('kpi-neutral').textContent = `${((neutrals / total) * 100).toFixed(0)}%`;
                } else {
                    ['kpi-positive', 'kpi-negative', 'kpi-neutral'].forEach(id => document.getElementById(id).textContent = '0%');
                }

                updateSentimentChart(filteredMentions);
                updateChannelChart(filteredMentions);
                updateTopicChart(filteredMentions);
                renderMentionsFeed(filteredMentions);
            };

            const updateChart = (chartInstance, elementId, type, data, options) => {
                if (chartInstance) chartInstance.destroy();
                const ctx = document.getElementById(elementId).getContext('2d');
                return new Chart(ctx, { type, data, options });
            };

            const updateSentimentChart = (data) => {
                const counts = data.reduce((acc, m) => { acc[m.sentiment] = (acc[m.sentiment] || 0) + 1; return acc; }, {});
                const chartData = {
                    labels: Object.keys(counts),
                    datasets: [{ data: Object.values(counts), backgroundColor: Object.keys(counts).map(s => sentimentColors[s]), borderColor: '#fff', borderWidth: 2 }]
                };
                sentimentChart = updateChart(sentimentChart, 'sentiment-chart', 'doughnut', chartData, { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } });
            };
            const updateChannelChart = (data) => {
                const counts = data.reduce((acc, m) => { acc[m.channel] = (acc[m.channel] || 0) + 1; return acc; }, {});
                const chartData = { labels: Object.keys(counts), datasets: [{ label: 'Menções', data: Object.values(counts), backgroundColor: chartColors, borderRadius: 5 }] };
                channelChart = updateChart(channelChart, 'channel-chart', 'bar', chartData, { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { precision: 0 } } } });
            };
            const updateTopicChart = (data) => {
                const counts = data.reduce((acc, m) => { acc[m.topic] = (acc[m.topic] || 0) + 1; return acc; }, {});
                const sorted = Object.entries(counts).sort(([,a],[,b]) => b-a);
                const chartData = { labels: sorted.map(i => i[0]), datasets: [{ label: 'Menções', data: sorted.map(i => i[1]), backgroundColor: chartColors, borderRadius: 5 }] };
                topicChart = updateChart(topicChart, 'topic-chart', 'bar', chartData, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } });
            };

            // Event listener para o formulário
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitButton.disabled = true;
                buttonText.classList.add('hidden');
                buttonLoader.classList.remove('hidden');

                const formData = new FormData(form);
                const newMention = Object.fromEntries(formData.entries());
                newMention.id = Date.now();

                try {
                    await fetch(SCRIPT_URL, {
                        method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newMention)
                    });
                    mentions.unshift(newMention);
                    populateChannelFilter();
                    updateDashboard();
                    form.reset();
                    document.getElementById('date').valueAsDate = new Date();
                    showFeedback('Menção salva com sucesso!');
                } catch (error) {
                    console.error('Falha ao salvar menção:', error);
                    showFeedback('Erro ao salvar. Tente novamente.', 'error');
                } finally {
                    submitButton.disabled = false;
                    buttonText.classList.remove('hidden');
                    buttonLoader.classList.add('hidden');
                }
            });

            // Event listeners para os filtros
            [filterChannel, filterSentiment].forEach(filter => {
                filter.addEventListener('change', updateDashboard);
            });

            // --- Inicialização da Aplicação ---
            document.getElementById('date').valueAsDate = new Date();
            loadMentions();
        });
    </script>
</body>
</html>

